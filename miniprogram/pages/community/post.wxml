<!--pages/community/post.wxml-->
<view class="post-container">
  <!-- 图片选择器（发布模式可编辑） -->
  <view class="uploader-section" wx:if="{{!isEditMode}}">
    <van-uploader
      file-list="{{ fileList }}"
      max-count="16"
      accept="image"
      bind:after-read="afterRead"
      bind:delete="deleteImage"
      preview-size="200rpx"
    />
  </view>

  <!-- 图片预览（编辑模式只读） -->
  <view class="images-preview-section" wx:if="{{isEditMode && fileList.length > 0}}">
    <view class="preview-tip">
      <van-icon name="info-o" size="14" color="#999" />
      <text>图片初始发布后不允许被修改，如需更换请删帖重发</text>
    </view>
    <scroll-view class="images-scroll" scroll-x enable-flex enhanced show-scrollbar="{{false}}"  scroll-with-animation>
      <view class="preview-image-list">
        <image 
          class="preview-image" 
          wx:for="{{fileList}}" 
          wx:key="index" 
          src="{{item.url}}" 
          mode="aspectFill"
          bindtap="previewEditImage"
          data-index="{{index}}"
        />
      </view>
    </scroll-view>
  </view>

  <!-- 内容输入区 -->
  <view class="content-section">
    <view class="title-row">
      <input 
        class="title-input"
        placeholder="添加标题"
        placeholder-class="placeholder-title"
        value="{{title}}"
        bindinput="onTitleInput"
        maxlength="40"
      />
      <view class="title-count {{title.length >= 40 ? 'count-limit' : (title.length >= 35 ? 'count-warning' : '')}}">
        {{title.length}}/40
      </view>
    </view>
    <textarea 
      class="content-textarea"
      placeholder="添加正文"
      placeholder-class="placeholder-content"
      value="{{content}}"
      bindinput="onContentInput"
      auto-height
      maxlength="1000"
    />
    <view class="content-count" wx:if="{{content.length > 800}}">
      <text class="{{content.length >= 1000 ? 'count-limit' : ''}}">{{content.length}}</text>/1000
    </view>
  </view>

  <!-- 话题标签区 - 新版三位一体设计 -->
  <view class="tags-section">
    <!-- 第一行：预设标签滚动区 -->
    <scroll-view class="preset-tags-scroll" scroll-x enable-flex enhanced show-scrollbar="{{false}}"  scroll-with-animation>
      <view class="preset-tags-list">
        <view 
          class="preset-tag {{selectedTags.includes(item) ? 'selected' : ''}}"
          wx:for="{{recommendTags}}"
          wx:key="index"
          bindtap="togglePresetTag"
          data-tag="{{item}}"
        >
          <text class="tag-hash">#</text>
          <text class="tag-name">{{item}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- 第二行：话题入口 + 已选标签 -->
    <view class="selected-tags-row">
      <!-- 话题功能入口按钮 -->
      <view class="topic-entry-btn" bindtap="openTopicSearch">
        <van-icon name="add-o" size="16" color="#b63b36" />
        <text>话题</text>
      </view>

      <!-- 已选标签展示区 -->
      <view 
        class="selected-tag"
        wx:for="{{selectedTags}}"
        wx:key="index"
      >
        <text class="selected-tag-text"># {{item}}</text>
        <view class="selected-tag-close" bindtap="removeTag" data-index="{{index}}">
          <van-icon name="cross" size="12" color="#fff" />
        </view>
      </view>
    </view>

    <!-- 标签数量提示 -->
    <view class="tags-count-tip" wx:if="{{selectedTags.length > 0}}">
      <text>已选 {{selectedTags.length}}/10 个话题</text>
    </view>
  </view>

  <!-- 选项列表 -->
  <view class="options-section">
    <van-cell-group>
      <van-cell 
        title="关联非遗项目" 
        is-link 
        value="{{selectedProject || '选填'}}"
        bind:click="showProjectPicker"
        title-style="color: #333"
      />
      <van-cell 
        title="标记地点" 
        is-link 
        value="{{location.name || '必填'}}"
        bind:click="chooseLocation"
        title-style="color: #333"
        icon="location-o"
      />
    </van-cell-group>
  </view>

  <!-- 底部操作栏 -->
  <view class="action-bar">
    <view class="draft-btn" bindtap="saveDraft" wx:if="{{!isEditMode}}">
      <text>存草稿</text>
    </view>
    <view class="publish-btn" bindtap="publishPost">
      <text>{{isEditMode ? '保存修改' : '发布笔记'}}</text>
    </view>
  </view>

  <!-- 非遗项目选择器 -->
  <van-popup 
    show="{{ showPicker }}" 
    position="bottom"
    bind:close="hideProjectPicker"
    round
  >
    <van-picker
      columns="{{ projectOptions }}"
      bind:confirm="onProjectConfirm"
      bind:cancel="hideProjectPicker"
      show-toolbar
      title="选择非遗项目"
      confirm-button-text="确定"
      cancel-button-text="取消"
    />
  </van-popup>

  <!-- 话题搜索浮层 -->
  <topic-search 
    show="{{ showTopicSearch }}"
    selected-tags="{{ selectedTags }}"
    max-count="{{ 10 }}"
    bind:select="onTopicSelect"
    bind:close="closeTopicSearch"
  />
</view>
