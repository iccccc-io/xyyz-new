<!--pages/community/detail.wxml-->
<view class="detail-container">
  <block wx:if="{{postData}}">
    <!-- é¡¶éƒ¨ä½œè€…æ  -->
    <view class="author-bar">
      <view class="author-left">
        <image class="author-avatar" src="{{postData.author_info.avatar_file_id}}" />
        <view class="author-text">
          <text class="author-name {{postData.author_info.is_certified ? 'certified' : ''}}">{{postData.author_info.nickname}}</text>
          <!-- å¤´è¡”ï¼šè®¤è¯ç”¨æˆ·éœ€ç­‰å¾…è¯¦æƒ…åŠ è½½ï¼Œéè®¤è¯ç”¨æˆ·ç›´æ¥æ˜¾ç¤º -->
          <text class="author-title loading" wx:if="{{postData.author_info.is_certified && !authorDataLoaded}}">Â· Â· Â·</text>
          <text class="author-title" wx:elif="{{postData.author_info.is_certified}}">{{authorData.certified_title || 'éé—ä¼ æ‰¿äºº'}}</text>
          <text class="author-title" wx:else>éé—çˆ±å¥½è€…</text>
        </view>
      </view>
      <!-- å…³æ³¨æŒ‰é’®ï¼šåŠ è½½ä¸­æ˜¾ç¤ºå ä½ï¼ŒåŠ è½½åæ˜¾ç¤ºçœŸå®çŠ¶æ€ -->
      <view 
        class="follow-btn loading" 
        wx:if="{{!isSelf && !followStatusLoaded}}"
      >
        <text>Â· Â· Â·</text>
      </view>
      <view 
        class="follow-btn {{isFollowing ? 'following' : ''}}" 
        wx:if="{{!isSelf && followStatusLoaded}}"
        bindtap="onFollowTap"
      >
        <text wx:if="{{!isFollowing}}">+ å…³æ³¨</text>
        <text wx:elif="{{isMutual}}">äº’ç›¸å…³æ³¨</text>
        <text wx:else>å·²å…³æ³¨</text>
      </view>
    </view>

    <!-- å›¾ç‰‡å±•ç¤º -->
    <view class="images-wrapper" wx:if="{{postData.images && postData.images.length > 0}}">
      <!-- å•å›¾å±•ç¤º -->
      <view wx:if="{{postData.images.length === 1}}" class="single-image-wrapper">
        <image 
          class="single-image" 
          src="{{postData.images[0]}}" 
          mode="widthFix"
          bindtap="previewImage"
          data-url="{{postData.images[0]}}"
        />
      </view>
      
      <!-- å¤šå›¾è½®æ’­ -->
      <swiper 
        wx:if="{{postData.images.length > 1}}"
        class="image-swiper"
        style="height: {{swiperHeight}}px;"
        indicator-dots
        indicator-color="rgba(255, 255, 255, 0.5)"
        indicator-active-color="#b63b36"
        circular
        current="{{currentImageIndex}}"
        bindchange="onSwiperChange"
      >
        <swiper-item wx:for="{{postData.images}}" wx:key="index">
          <view class="swiper-item-wrapper">
            <image 
              class="swiper-image" 
              src="{{item}}" 
              mode="widthFix"
              bindtap="previewImage"
              data-url="{{item}}"
              bindload="onImageLoad"
              data-index="{{index}}"
            />
          </view>
        </swiper-item>
      </swiper>
      
      <!-- å›¾ç‰‡è®¡æ•° -->
      <view class="image-indicator" wx:if="{{postData.images.length > 1}}">
        <text>{{currentImageIndex + 1}} / {{postData.images.length}}</text>
      </view>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="content-section">
      <!-- æ ‡é¢˜ -->
      <view class="post-title">{{postData.title}}</view>
      
      <!-- æ­£æ–‡ -->
      <view class="post-content">{{postData.content}}</view>

      <!-- éé—æ ‡ç­¾ -->
      <view class="project-tags" wx:if="{{postData.related_projects && postData.related_projects.length > 0}}">
        <view 
          class="project-tag-item"
          wx:for="{{postData.related_projects}}"
          wx:key="id"
          bindtap="goToProject"
          data-id="{{item.id}}"
        >
          <text class="tag-icon">ğŸ·ï¸</text>
          <text class="tag-name">{{item.name}}</text>
        </view>
      </view>

      <!-- æ™®é€šæ ‡ç­¾ -->
      <view class="normal-tags" wx:if="{{postData.tags && postData.tags.length > 0}}">
        <view class="normal-tag" wx:for="{{postData.tags}}" wx:key="index">#{{item}}</view>
      </view>

      <!-- ä½ç½®å’Œæ—¶é—´ä¿¡æ¯ -->
      <view class="meta-info">
        <view class="location-info" wx:if="{{postData.location && postData.location.name}}" bindtap="openLocation">
          <van-icon name="location-o" size="14" color="#999" />
          <text class="location-text">{{postData.location.name}}</text>
        </view>
        <view class="time-info">
          <text class="time-text">{{formatTime}}</text>
        </view>
      </view>
    </view>

    <!-- åˆ†éš”çº¿ -->
    <view class="divider-line"></view>

    <!-- è¯„è®ºåŒº -->
    <view class="comment-section">
      <view class="comment-header">
        <text class="comment-title">å…± {{commentCount}} æ¡è¯„è®º</text>
      </view>

      <!-- è¯„è®ºåŠ è½½ä¸­ -->
      <view class="comments-loading" wx:if="{{commentsLoading}}">
        <van-loading type="spinner" color="#b63b36" size="24">åŠ è½½è¯„è®ºä¸­...</van-loading>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comment-list" wx:if="{{!commentsLoading && commentList.length > 0}}">
        <view class="comment-item-wrapper" wx:for="{{commentList}}" wx:key="_id" wx:for-index="commentIndex">
          <!-- ä¸€çº§è¯„è®º -->
          <view class="comment-item level-1">
            <image class="comment-avatar" src="{{item.user_info.avatar || '/images/icons/avatar.png'}}" />
            <view class="comment-main">
              <view class="comment-user-row">
                <text class="comment-user">{{item.user_info.nickname}}</text>
              </view>
              <view class="comment-text" bindtap="onCommentTap" data-comment="{{item}}">{{item.content}}</view>
              <view class="comment-footer">
                <text class="comment-time">{{item.create_time_formatted}}</text>
                <view class="comment-actions">
                  <view class="comment-reply-btn" bindtap="onCommentTap" data-comment="{{item}}">
                    <text>å›å¤</text>
                  </view>
                  <view 
                    class="comment-like-btn {{item.isLiked ? 'liked' : ''}}" 
                    bindtap="onCommentLikeTap" 
                    data-commentid="{{item._id}}" 
                    data-index="{{commentIndex}}"
                  >
                    <van-icon name="{{item.isLiked ? 'like' : 'like-o'}}" size="14" color="{{item.isLiked ? '#b63b36' : '#999'}}" />
                    <text wx:if="{{item.like_count > 0}}">{{item.like_count}}</text>
                  </view>
                </view>
              </view>

              <!-- äºŒçº§è¯„è®ºåŒº -->
              <view class="replies-section" wx:if="{{item.reply_count > 0}}">
                <!-- å·²åŠ è½½çš„å›å¤ -->
                <view class="reply-item" wx:for="{{item.replies}}" wx:key="_id" wx:for-item="reply">
                  <image class="reply-avatar" src="{{reply.user_info.avatar || '/images/icons/avatar.png'}}" />
                  <view class="reply-main">
                    <view class="reply-content" bindtap="onCommentTap" data-comment="{{reply}}">
                      <text class="reply-user">{{reply.user_info.nickname}}</text>
                      <text class="reply-to" wx:if="{{reply.reply_to}}"> å›å¤ <text class="reply-to-name">@{{reply.reply_to.nickname}}</text></text>
                      <text class="reply-text">ï¼š{{reply.content}}</text>
                    </view>
                    <view class="reply-footer">
                      <text class="reply-time">{{reply.create_time_formatted}}</text>
                      <view class="reply-actions">
                        <view class="reply-action" bindtap="onCommentTap" data-comment="{{reply}}">
                          <text>å›å¤</text>
                        </view>
                        <view 
                          class="reply-like-btn {{reply.isLiked ? 'liked' : ''}}" 
                          bindtap="onCommentLikeTap" 
                          data-commentid="{{reply._id}}" 
                          data-index="{{commentIndex}}"
                          data-replyindex="{{index}}"
                        >
                          <van-icon name="{{reply.isLiked ? 'like' : 'like-o'}}" size="12" color="{{reply.isLiked ? '#b63b36' : '#999'}}" />
                          <text wx:if="{{reply.like_count > 0}}">{{reply.like_count}}</text>
                        </view>
                      </view>
                    </view>
                  </view>
                </view>

                <!-- å±•å¼€æ›´å¤šå›å¤ -->
                <view 
                  class="expand-replies" 
                  wx:if="{{item.reply_count > 2 && !item.showAllReplies}}"
                  bindtap="expandReplies"
                  data-commentid="{{item._id}}"
                  data-index="{{commentIndex}}"
                >
                  <text>å±•å¼€ {{item.reply_count - 2}} æ¡å›å¤</text>
                  <van-icon name="arrow-down" size="12" color="#666" />
                </view>

                <!-- æ”¶èµ·å›å¤ -->
                <view 
                  class="collapse-replies" 
                  wx:if="{{item.reply_count > 2 && item.showAllReplies}}"
                  bindtap="collapseReplies"
                  data-index="{{commentIndex}}"
                >
                  <text>æ”¶èµ·</text>
                  <van-icon name="arrow-up" size="12" color="#666" />
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ— è¯„è®º -->
      <view class="no-comment" wx:if="{{!commentsLoading && commentList.length === 0}}">
        <text class="no-comment-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</text>
      </view>
    </view>

    <!-- åº•éƒ¨äº’åŠ¨æ  -->
    <view class="action-bar">
      <view class="action-input" bindtap="onInputAreaTap">
        <input 
          class="comment-input" 
          placeholder="{{inputPlaceholder}}"
          value="{{inputValue}}"
          focus="{{inputFocus}}"
          bindinput="onInputChange"
          bindblur="onInputBlur"
          confirm-type="send"
          bindconfirm="sendComment"
          adjust-position="{{true}}"
        />
      </view>
      <view class="action-right">
        <!-- å‘é€æŒ‰é’®ï¼ˆè¾“å…¥æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="send-btn" wx:if="{{inputValue}}" bindtap="sendComment">
          <text>å‘é€</text>
        </view>
        <!-- äº’åŠ¨å›¾æ ‡ï¼ˆéè¾“å…¥æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="action-icons" wx:else>
          <view class="action-icon-item {{isLiked ? 'liked' : ''}}" bindtap="onLikeTap">
            <van-icon name="{{isLiked ? 'like' : 'like-o'}}" size="22" color="{{isLiked ? '#b63b36' : '#333'}}" />
            <text class="action-count {{isLiked ? 'liked' : ''}}">{{likesFormatted}}</text>
          </view>
          <view class="action-icon-item">
            <van-icon name="star-o" size="22" color="#333" />
            <text class="action-count">0</text>
          </view>
          <view class="action-icon-item">
            <van-icon name="chat-o" size="22" color="#333" />
            <text class="action-count">{{commentsFormatted}}</text>
          </view>
        </view>
      </view>
    </view>
  </block>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-wrapper" wx:if="{{loading}}">
    <van-loading type="spinner" color="#b63b36" size="40">åŠ è½½ä¸­...</van-loading>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-wrapper" wx:if="{{!loading && !postData}}">
    <van-empty description="å¸–å­ä¸å­˜åœ¨" />
  </view>
</view>
