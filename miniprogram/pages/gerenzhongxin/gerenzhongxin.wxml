<!--pages/gerenzhongxin/gerenzhongxin.wxml-->
<view class="user-container">
  <!-- 头部沉浸区 -->
  <view class="immersive-header">
    <!-- 用户信息 -->
    <view class="user-profile">
      <image class="user-avatar" src="{{isLoggedIn ? userInfo.avatar_url : '/images/icons/avatar.png'}}" />
      <view class="user-info">
        <view class="user-name-row">
          <text class="user-nickname">{{isLoggedIn ? userInfo.nickname : '游客用户'}}</text>
          <van-icon 
            wx:if="{{isLoggedIn && userInfo.is_certified}}" 
            name="medal-o" 
            size="20" 
            color="#FFD700" 
          />
        </view>
        <view class="certified-tag" wx:if="{{isLoggedIn && userInfo.is_certified && userInfo.certified_title}}">
          <text>{{userInfo.certified_title}}</text>
        </view>
        <view class="normal-tag" wx:if="{{isLoggedIn && !userInfo.is_certified}}">
          <text>非遗爱好者</text>
        </view>
        <view class="guest-tag" wx:if="{{!isLoggedIn}}">
          <text>点击登录体验更多功能</text>
        </view>
      </view>
    </view>

    <!-- 数据统计栏 (毛玻璃) -->
    <view class="stats-bar">
      <view class="stat-item">
        <text class="stat-number">{{userInfo.stats.following || 0}}</text>
        <text class="stat-label">关注</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{userInfo.stats.followers || 0}}</text>
        <text class="stat-label">粉丝</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{userInfo.stats.likes || 0}}</text>
        <text class="stat-label">获赞</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{viewsFormatted}}</text>
        <text class="stat-label">浏览</text>
      </view>
    </view>
  </view>

  <!-- 核心功能区 (悬浮白色卡片) -->
  <view class="floating-body">
    <!-- 我的订单 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">我的文创订单</text>
        <view class="section-more" bindtap="goToAllOrders">
          <text>全部</text>
          <van-icon name="arrow" size="14" color="#999" />
        </view>
      </view>
      <view class="order-grid">
        <view class="order-item" bindtap="goToOrders" data-status="0">
          <view class="order-icon-wrapper">
            <van-icon name="balance-o" size="28" color="#b63b36" />
            <view class="order-badge" wx:if="{{orderCounts.pending > 0}}">{{orderCounts.pending}}</view>
          </view>
          <text class="order-label">待支付</text>
        </view>
        <view class="order-item" bindtap="goToOrders" data-status="1">
          <view class="order-icon-wrapper">
            <van-icon name="gift-o" size="28" color="#b63b36" />
            <view class="order-badge" wx:if="{{orderCounts.toShip > 0}}">{{orderCounts.toShip}}</view>
          </view>
          <text class="order-label">待发货</text>
        </view>
        <view class="order-item" bindtap="goToOrders" data-status="2">
          <view class="order-icon-wrapper">
            <van-icon name="logistics" size="28" color="#b63b36" />
            <view class="order-badge" wx:if="{{orderCounts.toReceive > 0}}">{{orderCounts.toReceive}}</view>
          </view>
          <text class="order-label">待收货</text>
        </view>
        <view class="order-item" bindtap="goToOrders" data-status="3">
          <view class="order-icon-wrapper">
            <van-icon name="passed" size="28" color="#b63b36" />
          </view>
          <text class="order-label">已完成</text>
        </view>
        <view class="order-item" bindtap="goToOrders" data-status="4">
          <view class="order-icon-wrapper">
            <van-icon name="service-o" size="28" color="#b63b36" />
          </view>
          <text class="order-label">售后</text>
        </view>
      </view>
    </view>

    <!-- 常用工具 -->
    <view class="section-card tools-card">
      <view class="section-header">
        <text class="section-title">常用工具</text>
      </view>
      <van-cell-group border="{{false}}">
        <van-cell 
          title="收货地址" 
          icon="location-o" 
          is-link 
          bindtap="goToAddress"
        />
        <van-cell 
          title="{{userInfo.is_certified ? '认证信息' : '申请认证'}}" 
          icon="certificate" 
          is-link
          bindtap="goToCertify"
        />
        <van-cell 
          title="非遗足迹" 
          icon="guide-o" 
          is-link
          bindtap="goToFootprint"
        />
        <van-cell 
          title="联系客服" 
          icon="service-o" 
          is-link
          bindtap="contactService"
        />
        <!-- 退出登录（仅登录后显示） -->
        <van-cell 
          wx:if="{{isLoggedIn}}"
          title="退出登录" 
          icon="revoke" 
          is-link
          title-class="logout-cell-title"
          bindtap="onLogout"
        />
      </van-cell-group>
    </view>

    <!-- 内容瀑布流 Tabs -->
    <view class="content-tabs-wrapper">
      <van-tabs 
        active="{{ activeTab }}" 
        bind:change="onTabChange"
        sticky
        offset-top="{{0}}"
        color="#b63b36"
        title-active-color="#b63b36"
      >
        <van-tab title="我的笔记">
          <view class="waterfall-container" wx:if="{{userPosts.length > 0}}">
            <!-- 左列 -->
            <view class="waterfall-column">
              <view 
                class="post-card"
                wx:for="{{leftPosts}}"
                wx:key="_id"
                bindtap="goToPostDetail"
                data-id="{{item._id}}"
              >
                <view class="card-cover">
                  <image class="cover-image" src="{{item.images[0]}}" mode="widthFix" lazy-load />
                  <view class="image-count" wx:if="{{item.images.length > 1}}">
                    <van-icon name="photo-o" size="12" color="#fff" />
                    <text>{{item.images.length}}</text>
                  </view>
                </view>
                <view class="card-content">
                  <view class="title-row">
                    <text class="project-tag" wx:if="{{item.related_projects && item.related_projects.length > 0}}">{{item.related_projects[0].name}}</text><text class="post-title">{{item.title}}</text>
                  </view>
                  <view class="card-footer">
                    <view class="like-info">
                      <van-icon name="like-o" size="14" color="#999" />
                      <text class="like-count">{{item.likes}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
            <!-- 右列 -->
            <view class="waterfall-column">
              <view 
                class="post-card"
                wx:for="{{rightPosts}}"
                wx:key="_id"
                bindtap="goToPostDetail"
                data-id="{{item._id}}"
              >
                <view class="card-cover">
                  <image class="cover-image" src="{{item.images[0]}}" mode="widthFix" lazy-load />
                  <view class="image-count" wx:if="{{item.images.length > 1}}">
                    <van-icon name="photo-o" size="12" color="#fff" />
                    <text>{{item.images.length}}</text>
                  </view>
                </view>
                <view class="card-content">
                  <view class="title-row">
                    <text class="project-tag" wx:if="{{item.related_projects && item.related_projects.length > 0}}">{{item.related_projects[0].name}}</text><text class="post-title">{{item.title}}</text>
                  </view>
                  <view class="card-footer">
                    <view class="like-info">
                      <van-icon name="like-o" size="14" color="#999" />
                      <text class="like-count">{{item.likes}}</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
          <view class="empty-posts" wx:if="{{userPosts.length === 0}}">
            <van-empty description="{{isLoggedIn ? '还没有发布笔记' : '登录后查看您的笔记'}}" />
          </view>
        </van-tab>
        <van-tab title="我的收藏">
          <view class="empty-posts">
            <van-empty description="{{isLoggedIn ? '暂无收藏内容' : '登录后查看您的收藏'}}" />
          </view>
        </van-tab>
      </van-tabs>
    </view>
  </view>

  <!-- 游客蒙版（未登录时显示） -->
  <view class="guest-overlay" wx:if="{{!isLoggedIn}}">
    <view class="overlay-content">
      <view class="overlay-icon">
        <van-icon name="user-circle-o" size="80" color="#8B2E2A" />
      </view>
      <text class="overlay-title">登录后体验更多功能</text>
      <text class="overlay-desc">查看订单、发布笔记、收藏好物</text>
      <button class="overlay-login-btn" bindtap="goToLogin">
        <text>立即登录</text>
      </button>
      <view class="overlay-skip" bindtap="goToLogin">
        <text>或 注册新账号</text>
      </view>
    </view>
  </view>
</view>
