<!--pages/mall/detail.wxml-->
<view class="detail-container" wx:if="{{!loading && product}}">
  <!-- é¦–å±å¤§å›¾è½®æ’­ -->
  <view class="image-section">
    <swiper 
      class="image-swiper"
      indicator-dots="{{product.detail_imgs.length > 1}}"
      indicator-color="rgba(255,255,255,0.5)"
      indicator-active-color="#ffffff"
      bindchange="onSwiperChange"
    >
      <swiper-item 
        wx:for="{{product.detail_imgs}}" 
        wx:key="*this"
        bindtap="previewImage"
      >
        <image class="swiper-image" src="{{item}}" mode="aspectFill" />
      </swiper-item>
    </swiper>
    <!-- å›¾ç‰‡è®¡æ•° -->
    <view class="image-counter" wx:if="{{product.detail_imgs.length > 1}}">
      <text>{{currentImageIndex + 1}}/{{product.detail_imgs.length}}</text>
    </view>
    <!-- å¼§å½¢é®ç½© -->
    <view class="curve-mask"></view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-section">
    <!-- ä»·æ ¼ä¸æ ‡é¢˜ -->
    <view class="info-card">
      <view class="price-row">
        <view class="price-group">
          <text class="currency">Â¥</text>
          <text class="current-price">{{product.price}}</text>
          <text class="original-price" wx:if="{{product.original_price}}">Â¥{{product.original_price}}</text>
        </view>
        <view class="sales-info">
          <text class="sales-text">å·²å”® {{product.sales || 0}}</text>
        </view>
      </view>
      
      <!-- æ ‡ç­¾ -->
      <view class="tags-row" wx:if="{{product.tags && product.tags.length > 0}}">
        <van-tag 
          wx:for="{{product.tags}}" 
          wx:key="*this"
          plain
          color="#8B2E2A"
          custom-class="product-tag"
        >{{item}}</van-tag>
      </view>
      
      <view class="title-row">
        <text class="product-title">{{product.title}}</text>
      </view>
      
      <view class="origin-row">
        <text class="origin-icon">ğŸ“</text>
        <text class="origin-text">{{product.origin || 'æ¹–å—'}}</text>
        <text class="stock-text">åº“å­˜ {{product.stock}} ä»¶</text>
      </view>
    </view>

    <!-- æ–‡åŒ–æº¯æºå¡ç‰‡ -->
    <view class="traceability-card" wx:if="{{product.related_project_name}}" bindtap="goToProject">
      <view class="trace-left">
        <view class="trace-icon">
          <van-icon name="bookmark-o" size="24" color="#8B2E2A" />
        </view>
        <view class="trace-info">
          <text class="trace-label">æœ¬å•†å“æºè‡ªéé—é¡¹ç›®</text>
          <text class="trace-name">{{product.related_project_name}}</text>
        </view>
      </view>
      <view class="trace-right">
        <text class="trace-link">å»äº†è§£</text>
        <van-icon name="arrow" size="14" color="#8B2E2A" />
      </view>
    </view>

    <!-- å•†å“ç®€ä»‹ -->
    <view class="intro-card">
      <view class="card-header">
        <view class="header-line"></view>
        <text class="header-title">å•†å“ç®€ä»‹</text>
        <view class="header-line"></view>
      </view>
      <text class="intro-text">{{product.intro || 'æš‚æ— ç®€ä»‹'}}</text>
    </view>

    <!-- è´­ä¹°æ•°é‡ -->
    <view class="quantity-card">
      <text class="quantity-label">è´­ä¹°æ•°é‡</text>
      <view class="quantity-control">
        <view class="qty-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="decreaseQuantity">
          <van-icon name="minus" size="16" color="{{quantity <= 1 ? '#ccc' : '#333'}}" />
        </view>
        <text class="qty-value">{{quantity}}</text>
        <view class="qty-btn {{quantity >= product.stock ? 'disabled' : ''}}" bindtap="increaseQuantity">
          <van-icon name="plus" size="16" color="{{quantity >= product.stock ? '#ccc' : '#333'}}" />
        </view>
      </view>
    </view>

    <!-- è¯¦æƒ…å›¾ç‰‡ -->
    <view class="detail-images" wx:if="{{product.detail_imgs && product.detail_imgs.length > 0}}">
      <view class="card-header">
        <view class="header-line"></view>
        <text class="header-title">å•†å“è¯¦æƒ…</text>
        <view class="header-line"></view>
      </view>
      <image 
        wx:for="{{product.detail_imgs}}" 
        wx:key="*this"
        class="detail-image"
        src="{{item}}"
        mode="widthFix"
        lazy-load
      />
    </view>
  </view>

  <!-- åº•éƒ¨å ä½ -->
  <view class="bottom-placeholder"></view>
</view>

<!-- æ‚¬æµ®æ“ä½œæ  (Apple Style) -->
<view class="action-bar" style="padding-bottom: calc(30rpx + {{safeAreaBottom}}px);" wx:if="{{!loading && product}}">
  <view class="action-bar-content">
    <!-- æ”¶è—æŒ‰é’® -->
    <view class="action-icon" bindtap="toggleFavorite">
      <van-icon name="{{isFavorite ? 'star' : 'star-o'}}" size="24" color="{{isFavorite ? '#8B2E2A' : '#666'}}" />
    </view>
    <!-- åŠ å…¥è´­ç‰©è½¦ -->
    <view class="action-btn cart-btn" bindtap="addToCart">
      <van-icon name="cart-o" size="20" color="#8B2E2A" />
      <text>åŠ å…¥è´­ç‰©è½¦</text>
    </view>
    <!-- ç«‹å³è´­ä¹° -->
    <view class="action-btn buy-btn" bindtap="buyNow">
      <text>ç«‹å³è´­ä¹°</text>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-state" wx:if="{{loading}}">
  <van-loading size="24px" color="#8B2E2A">åŠ è½½ä¸­...</van-loading>
</view>

